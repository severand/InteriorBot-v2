# 🏗️ Архитектура проекта InteriorBot-v2

## 📋 Оглавление

1. [Общее описание проекта](#общее-описание-проекта)
2. [Технологический стек](#технологический-стек)
3. [Структура проекта](#структура-проекта)
4. [Архитектура системы](#архитектура-системы)
5. [Компоненты системы](#компоненты-системы)
6. [Поток данных](#поток-данных)
7. [База данных](#база-данных)
8. [API и внешние сервисы](#api-и-внешние-сервисы)
9. [Система состояний (FSM)](#система-состояний-fsm)
10. [Обработка платежей](#обработка-платежей)
11. [Генерация изображений](#генерация-изображений)
12. [Административная панель](#административная-панель)
13. [Конфигурация и настройки](#конфигурация-и-настройки)
14. [Логирование и отладка](#логирование-и-отладка)
15. [Схемы взаимодействия](#схемы-взаимодействия)

---

## Общее описание проекта

**InteriorBot-v2** — это Telegram-бот для генерации дизайна интерьеров с использованием искусственного интеллекта. Бот позволяет пользователям создавать реалистичные визуализации интерьеров в различных стилях, используя модели DALL-E 3 через Replicate API.

### Основные возможности:

- ✅ Генерация дизайна интерьера по фотографии помещения
- ✅ 10+ стилей дизайна (современный, минимализм, скандинавский, индустриальный и др.)
- ✅ 12+ типов помещений (гостиная, спальня, кухня, ванная и др.)
- ✅ Система токенов с бесплатными генерациями для новых пользователей
- ✅ Интеграция платежной системы YooKassa
- ✅ Административная панель с аналитикой
- ✅ Подробное логирование и отладка

---

## Технологический стек

### Backend

- **Python 3.10+** — основной язык программирования
- **aiogram 3.x** — асинхронный фреймворк для Telegram Bot API
- **aiosqlite** — асинхронная работа с SQLite базой данных
- **asyncio** — асинхронное программирование

### AI & ML

- **DALL-E 3** (через Replicate API) — генерация изображений интерьеров
- **Stable Diffusion 3.5 Large** (резервная модель)
- **Replicate API** — платформа для запуска AI моделей

### Платежи

- **YooKassa** — прием платежей в России

### Инфраструктура

- **SQLite** — база данных
- **python-dotenv** — управление переменными окружения
- **aiohttp** — асинхронные HTTP-запросы

---

## Структура проекта

```
InteriorBot-v2/
├── bot/                          # Основная директория бота
│   ├── config.py                 # Конфигурация и настройки
│   ├── main.py                   # Точка входа приложения
│   │
│   ├── database/                 # Слой работы с базой данных
│   │   ├── db.py                # Database класс с методами
│   │   └── models.py            # SQL запросы и модели
│   │
│   ├── handlers/                 # Обработчики событий бота
│   │   ├── user_start.py        # Стартовые команды и меню
│   │   ├── creation.py          # Процесс генерации изображений
│   │   ├── payment.py           # Обработка платежей
│   │   ├── admin.py             # Административные команды
│   │   ├── design_step1_furniture.py  # Выбор мебели
│   │   ├── design_step2_colors.py     # Выбор цветовой гаммы
│   │   ├── design_mode_selector.py    # Выбор режима дизайна
│   │   └── webhook.py           # Webhook для платежей
│   │
│   ├── keyboards/                # Клавиатуры интерфейса
│   │   ├── inline.py            # Inline-клавиатуры (callback)
│   │   └── reply.py             # Reply-клавиатуры (основные)
│   │
│   ├── services/                 # Бизнес-логика и внешние сервисы
│   │   ├── replicate_api.py     # Работа с Replicate API (DALL-E 3)
│   │   ├── payment_api.py       # Работа с YooKassa
│   │   └── prompt_builder.py    # Построение промптов для AI
│   │
│   ├── states/                   # Машина состояний (FSM)
│   │   └── fsm.py               # Определение состояний бота
│   │
│   └── utils/                    # Вспомогательные утилиты
│       ├── texts.py             # Текстовые константы и сообщения
│       ├── helpers.py           # Вспомогательные функции
│       ├── navigation.py        # Навигация по меню
│       └── debug.py             # Инструменты отладки
│
├── requirements.txt              # Зависимости проекта
├── .gitignore                    # Игнорируемые файлы
├── test_dalle3_detailed.py       # Тестовый скрипт для DALL-E 3
├── README.md                     # Документация проекта
└── ARCHITECTURE.md              # Данный файл
```

---

## Архитектура системы

### Архитектурный паттерн

Проект использует **многослойную (Layered) архитектуру** с разделением ответственности:

```
┌─────────────────────────────────────────┐
│         Telegram Bot API                │
│     (Входная точка пользователя)        │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│         Handlers Layer                  │
│   (Обработка команд и callback'ов)      │
│   - user_start.py                       │
│   - creation.py                         │
│   - payment.py                          │
│   - admin.py                            │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│         Services Layer                  │
│      (Бизнес-логика)                    │
│   - replicate_api.py                    │
│   - payment_api.py                      │
│   - prompt_builder.py                   │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│         Database Layer                  │
│    (Работа с данными)                   │
│   - db.py                               │
│   - models.py                           │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│         SQLite Database                 │
│      (Хранилище данных)                 │
└─────────────────────────────────────────┘

        External Services:
┌─────────────────────────────────────────┐
│  - Replicate API (DALL-E 3)             │
│  - YooKassa (Payments)                  │
└─────────────────────────────────────────┘
```

### Принципы архитектуры

1. **Разделение ответственности** — каждый модуль отвечает за свою функциональность
2. **Асинхронность** — использование async/await для неблокирующих операций
3. **Слабая связанность** — модули независимы друг от друга
4. **Расширяемость** — легко добавлять новые стили, комнаты, функции
5. **Централизованная конфигурация** — все настройки в одном месте

---

*(Остальной текст остается неизменным до раздела "Административная панель")*

##  Административная панель

### Способы входа

Администраторы могут открыть админ-панель двумя способами:

1. **Через кнопку в главном меню:**
   - Кнопка "⚙️ Админ-панель" видна только пользователям из `ADMIN_IDS`
   - Callback: `open_admin_panel`
   - Обработчик: `open_admin_panel_callback()` в `handlers/admin.py`

2. **Через команду `/admin`:**
   - Доступна в любой момент времени
   - Обработчик: `admin_start()` в `handlers/admin.py`

### Проверка прав доступа

```python
if user_id not in ADMIN_IDS:
    await callback.answer(
        "❌ Доступ запрещён\n\nЭто меню только для администраторов.", 
        show_alert=True
    )
    return
```

Если пользователь не является администратором, показывается alert-сообщение о запрете доступа.

### Доступные команды

**Статистика:**

- `/admin` — главная панель администратора
- Просмотр общей статистики:
  - Всего пользователей
  - Новых за сегодня/неделю/месяц
  - Всего генераций
  - Генераций за сегодня
  - Выручка (всего/сегодня/неделя/месяц)

**Аналитика:**

- Популярные комнаты (топ-10)
- Популярные стили (топ-10)
- Финансовая статистика

**Управление:**

- Просмотр списка всех пользователей
- Управление администраторами
- Проверка статуса API токенов

### Структура меню

```
🔐 АДМИН-ПАНЕЛЬ
├─ 📊 Статистика
│   ├─ 📈 Общая статистика
│   ├─ 💰 Финансовая статистика
│   ├─ 🎨 Популярность стилей
│   └─ 🏠 Популярность комнат
├─ 👥 Пользователи
├─ 🔑 Администраторы
├─ 🔐 API Токены
└─ ⬅️ Главное меню
```

### Права доступа

```python
ADMIN_IDS = [
    7884972750,
    827652042,
    5426993389,
    6999935990
]
```

Только эти Telegram ID имеют доступ к административным функциям.

### Логирование админ-действий

Все действия администраторов детально логируются:

- `[ADMIN_PANEL]` — открытие панели через кнопку
- `[ADMIN_CMD]` — открытие панели через команду
- `[ADMIN_MENU]` — навигация внутри панели
- `[ADMIN_STATS]` — просмотр статистики
- `[ADMIN_USERS]` — просмотр пользователей

Пример лога:
```
2025-11-28 10:15:32,123 - handlers.admin - INFO - [ADMIN_PANEL] 🎯 Callback 'open_admin_panel' от user 7884972750
2025-11-28 10:15:32,145 - handlers.admin - INFO - [ADMIN_PANEL] ✅ Права доступа подтверждены для user 7884972750
2025-11-28 10:15:32,167 - handlers.admin - INFO - [ADMIN_PANEL] ✅ Админ-панель открыта для user 7884972750
```

---

*(Остальной текст документа остается неизменным)*

---

*Документация актуальна на: 28 ноября 2024*  
*Версия: 2.1*  
*Изменения: Добавлено описание кнопки Админ-панель и обработчика `open_admin_panel_callback()`*
